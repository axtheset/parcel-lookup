<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Leon County Record Lookup</title>

    <!-- Bootstrap core CSS -->
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://netdna.bootstrapcdn.com/bootswatch/3.1.1/spacelab/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        margin-top: 75px;
      }
    </style>

  </head>

  <body role="document">

    <!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand">Leon County Record Lookup</a>
        </div>
      </div>
    </div>

    <div class="container theme-showcase" role="main">

      <div id="working"><button type="button" value="" class="btn btn-lg btn-warning">Looking up records...</button></div>
      <div id="records"></div>
      
    </div> <!-- /container -->


    <!-- Le JavaScripts-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script>

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function setHeaders(xhr) {
          xhr.setRequestHeader("Authorization", token);
    }

    function buildACAUrl(baseUrl,module,recordId) {
      var recordIdArray = [];
      recordIdArray = recordId.split("-");

      return baseUrl + "?Module=" + module + "&TabName=" + module + "&capID1=" + recordIdArray[1] + "&capID2=" + recordIdArray[2] + "&capID3=" + recordIdArray[3]; 
    }

    function displayResults(data) {
      //console.log(data);
      $("#working").hide();
      $("#records").append("<table class=\"table table-striped table-bordered table-hover\">");
      for(var i=0; i<data.result.length; i++) {
        var acaUrl = "https://aca.accela.com/leonco/Cap/CapDetail.aspx?Module=Building&TabName=Building&capID1=15CBL&capID2=00000&capID3=00209"
        $("#records table").append("<tr><td>" +  data.result[i].statusDate + "</td><td><a class=\"details\" target=\"_blank\" href=\"" + buildACAUrl('https://acasupp3.accela.com/leonco/Cap/CapDetail.aspx',data.result[i].type.group,data.result[i].id) + "\">" + data.result[i].customId + "</a></td><td>" + data.result[i].type.text + "</td><td>" + data.result[i].status.text + "</td></tr>")
      }
      $("#records table").append("</table>");
    }

    var token = 'pMvBFsQGgph5VWsaA_WqDIXT3TFycl_SWmbYpLeTDxqu8kysEWze8zX4ede8N8x5XeAELeXUIg3rbDFc6fvrR8NXv-lrid-SGWP0FYL3liP-tnHequD4o2PXVtDT7mPhzQ6YnvFzB_9CmLMmqhujPCy6Pp0vOSoo6YqojzynKlYWdAPqpI_YtwtyU96n59wc4GbItcwC07m84gjrvCo4zgHbrvRBMUsK76gdx4hrcZKWw7taevdddt1sv3G4CYW89n9uQeM4q4L3QNWZ5KLuTeNIgnbWc_ZH7akfSSl1eqLW5cKnL7Q7OIqU1K_ph1cufryb-xBr9YlNrtN3fgLW-Vyl2UjMPhFwW3yBkJ7IKX84FhKJPLKb6bXLnIEQgfbieFT_AoElRsLbA0KSOIoOfGG2A2wFW2ttggX2MObpfPNSYjImm61l3j4cXm_KjGM70';

     $(document).ready(function() {

      var data = {module: 'Building', parcel: {}};
      var parcelnum = getParameterByName('parcelnum');
      data.parcel.parcelNubmer = parcelnum;

      console.log(JSON.stringify(data));
      
      $.ajax({
        url: 'https://apis.accela.com/v4/search/records',
        type: "POST",
        beforeSend: setHeaders,
        data: JSON.stringify(data),
        success: displayResults
      });

     });

    </script>
  </body>
</html>